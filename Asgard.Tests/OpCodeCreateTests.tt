<#@ template debug="true" hostspecific="true" language="C#" #>
<#@ assembly name="System.Core" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ import namespace="System.IO" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Text" #>
<#@ output extension=".cs" #>
<#	var filename = this.Host.ResolvePath("cbusdefs.csv");
	var textlines = File.ReadLines(filename);

	var opcodelines = 
		textlines
			.Where(n => n.StartsWith("CbusOpCodes,"))
			.ToList();

	var opcodedata =
		opcodelines
			.Select(n => n.Split(','))
			.Where(n => n.Length >= 4)
			.Where(n => n[2].StartsWith("0x"))
			.ToList();

	var opcodes =
		opcodedata
			.Select(n => n[2])
			.Distinct()
			.OrderBy(n => n)
			.ToList();
#>
using NUnit.Framework;

/*	This file is automatically generated by a T4 template from a data file.
	<#= filename #>
	Any changes made manually will be lost when the file is regenerated.
*/

namespace Asgard.Tests
{
	[TestFixture]
	public class OpCodeCreateTests
	{
		[SetUp]
		public void Setup()
		{
		}

<#	foreach(var opcodeNumber in opcodes)
	{
		var opcode = 
			opcodedata
				.FirstOrDefault(n => n[2] == opcodeNumber);
		if (opcode is null) continue;
		var opcodeName = opcode[1];
		if (opcodeName.StartsWith("OPC_"))
			opcodeName = opcodeName.Substring(4);
#>

		[Test]
		public void Create<#= opcodeName #>Test()
		{
			var data = new byte[]
			{
				<#= opcodeNumber #>,
			};
			var cbusMessage = CbusMessage.Create(data);

			var opcode = OpCodeData.Create(cbusMessage);

            Assert.Multiple(() =>
            {
                Assert.That(opcode, Is.Not.Null);
                Assert.That(opcode?.GetType().Name, Is.EqualTo("<#= opcodeName #>"));
            });
		}
<#	}
#>
	}
}
